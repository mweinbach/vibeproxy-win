<?xml version="1.0" encoding="UTF-8" ?>
<Page
    x:Class="VibeProxy.WinUI.Views.MainPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:helpers="using:VibeProxy.WinUI.Helpers"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewModels="using:VibeProxy.WinUI.ViewModels"
    mc:Ignorable="d"
    x:Name="Root">

    <Page.Resources>
        <helpers:BoolToVisibilityConverter x:Key="BoolToVisibility" />
        <helpers:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibility" />
        <helpers:ExpiredToBrushConverter x:Key="ExpiredBrush" />
        <helpers:StringToVisibilityConverter x:Key="StringToVisibility" />
        <helpers:BoolToStatusBrushConverter x:Key="StatusBrush" />
        <helpers:StatusToSeverityConverter x:Key="StatusToSeverityConverter" />
    </Page.Resources>

    <Grid>
        <NavigationView x:Name="NavView"
                        PaneDisplayMode="Left"
                        IsBackButtonVisible="Collapsed"
                        IsSettingsVisible="False"
                        SelectionChanged="OnNavSelectionChanged">
            <NavigationView.MenuItems>
                <NavigationViewItem Content="Dashboard" Tag="Dashboard" Icon="Home" />
                <NavigationViewItem Content="Services" Tag="Services" Icon="Characters" />
                <NavigationViewItem Content="Settings" Tag="Settings" Icon="Setting" />
                <NavigationViewItem Content="About" Tag="About" Icon="Info" />
            </NavigationView.MenuItems>

            <NavigationView.Content>
                <ScrollViewer x:Name="ContentScrollViewer" Padding="24">
                    <Grid>
                        <!-- Dashboard Section -->
                        <StackPanel x:Name="DashboardSection" Spacing="24">
                            <TextBlock Text="Dashboard" Style="{StaticResource HeaderTextBlockStyle}" />
                            
                            <Border Style="{StaticResource CardBorderStyle}">
                                <StackPanel Spacing="16">
                                    <StackPanel Orientation="Horizontal" Spacing="12">
                                        <FontIcon Glyph="&#xE73E;" Foreground="{x:Bind ViewModel.IsServerRunning, Converter={StaticResource StatusBrush}}" />
                                        <TextBlock Text="Server Status" VerticalAlignment="Center" FontWeight="SemiBold" />
                                        <TextBlock Text="{x:Bind ViewModel.ServerStatusText}" VerticalAlignment="Center" Foreground="Gray" />
                                    </StackPanel>
                                    
                                    <InfoBar IsOpen="True" 
                                             Severity="{x:Bind ViewModel.IsServerRunning, Mode=OneWay, Converter={StaticResource StatusToSeverityConverter}}"
                                             Title="{x:Bind ViewModel.ServerStatusText}"
                                             Message="Proxy server is active and listening for local requests."
                                             IsClosable="False" />

                                    <Button Content="Toggle Server" 
                                            Style="{StaticResource AccentButtonStyle}"
                                            Click="OnToggleServerClicked" 
                                            HorizontalAlignment="Left"/>
                                </StackPanel>
                            </Border>

                            <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                                <Border Grid.Column="0" Style="{StaticResource CardBorderStyle}">
                                    <StackPanel Spacing="8">
                                        <TextBlock Text="Environment" FontWeight="SemiBold" />
                                        <TextBlock Text="Port: 8317 (Thinking), 8318 (Backend)" FontSize="12" Foreground="Gray" />
                                        <Button Content="Copy URL" Click="OnCopyUrlClicked" Margin="0,8,0,0" />
                                    </StackPanel>
                                </Border>
                                <Border Grid.Column="1" Style="{StaticResource CardBorderStyle}">
                                    <StackPanel Spacing="8">
                                        <TextBlock Text="Auth Files" FontWeight="SemiBold" />
                                        <TextBlock Text="Manage your tokens locally" FontSize="12" Foreground="Gray" />
                                        <Button Content="Open Folder" Click="OnOpenAuthFolderClicked" Margin="0,8,0,0" />
                                    </StackPanel>
                                </Border>
                            </Grid>
                        </StackPanel>

                        <!-- Services Section -->
                        <StackPanel x:Name="ServicesSection" Spacing="24" Visibility="Collapsed">
                            <TextBlock Text="Internal Services" Style="{StaticResource HeaderTextBlockStyle}" />
                            
                            <ItemsControl ItemsSource="{x:Bind ViewModel.Services}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="viewModels:ServiceViewModel">
                                        <Expander HorizontalAlignment="Stretch" Padding="0">
                                            <Expander.Header>
                                                <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="12" VerticalAlignment="Center">
                                                    <Image Width="24" Height="24" Source="{x:Bind IconSource}" />
                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                        <TextBlock Text="{x:Bind DisplayName}" FontWeight="SemiBold" />
                                                        <TextBlock Text="{x:Bind SummaryText}" FontSize="12" Foreground="Gray" />
                                                    </StackPanel>
                                                    <ProgressRing Grid.Column="2" Width="16" Height="16" IsActive="{x:Bind IsAuthenticating}" Visibility="{x:Bind IsAuthenticating, Converter={StaticResource BoolToVisibility}}" />
                                                    <ToggleSwitch Grid.Column="3" IsOn="{x:Bind IsEnabled, Mode=TwoWay}" OnContent="" OffContent="" MinWidth="0" VerticalAlignment="Center" />
                                                </Grid>
                                            </Expander.Header>
                                            <StackPanel Spacing="12" Padding="16">
                                                <ItemsControl ItemsSource="{x:Bind Accounts}">
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate x:DataType="viewModels:AuthAccountViewModel">
                                                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10" Margin="0,0,0,8">
                                                                <Ellipse Width="8" Height="8" Fill="{x:Bind IsExpired, Converter={StaticResource ExpiredBrush}}" VerticalAlignment="Center" />
                                                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                                    <TextBlock Text="{x:Bind DisplayName}" FontSize="13" />
                                                                    <TextBlock Text="Expired" FontSize="11" Foreground="Orange" Visibility="{x:Bind IsExpired, Converter={StaticResource BoolToVisibility}}" />
                                                                </StackPanel>
                                                                <Button Grid.Column="2" Content="Remove" Command="{x:Bind RemoveCommand}" CommandParameter="{x:Bind}" FontSize="12" Padding="8,4" />
                                                            </Grid>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>

                                                <Button Content="Connect Account" 
                                                        Command="{x:Bind ConnectCommand}"
                                                        IsEnabled="{x:Bind IsEnabled}"
                                                        HorizontalAlignment="Stretch"
                                                        Margin="0,8,0,0" />

                                                <TextBlock Text="{x:Bind HelpText}" FontSize="12" Foreground="Gray" Style="{StaticResource CaptionTextBlockStyle}"
                                                           Visibility="{x:Bind HelpText, Converter={StaticResource StringToVisibility}}" />
                                            </StackPanel>
                                        </Expander>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <!-- Settings Section -->
                        <StackPanel x:Name="SettingsSection" Spacing="24" Visibility="Collapsed">
                            <TextBlock Text="Settings" Style="{StaticResource HeaderTextBlockStyle}" />
                            
                            <Border Style="{StaticResource CardBorderStyle}">
                                <StackPanel Spacing="16">
                                    <ToggleSwitch Header="Launch at Login" 
                                                  x:Name="LaunchToggle"
                                                  Toggled="OnLaunchAtLoginToggled"
                                                  OnContent="Enabled" OffContent="Disabled" />
                                    
                                    <TextBlock Text="VibeProxy will automatically start when you sign in to Windows." FontSize="12" Foreground="Gray" Margin="0,-8,0,0" />
                                </StackPanel>
                            </Border>

                            <Border Style="{StaticResource CardBorderStyle}">
                                <StackPanel Spacing="12">
                                    <TextBlock Text="Vercel AI Gateway" FontWeight="SemiBold" />
                                    <ToggleSwitch Header="Use Gateway for Claude"
                                                  IsOn="{Binding ElementName=Root, Path=ViewModel.SettingsStore.VercelGatewayEnabled, Mode=TwoWay}"
                                                  OnContent="On" OffContent="Off" />
                                    <StackPanel Spacing="4">
                                        <TextBlock Text="Vercel API Key" FontSize="12" />
                                        <PasswordBox Password="{Binding ElementName=Root, Path=ViewModel.SettingsStore.VercelApiKey, Mode=TwoWay}" PlaceholderText="Enter API Key" />
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <!-- About Section -->
                        <StackPanel x:Name="AboutSection" Spacing="24" Visibility="Collapsed">
                            <TextBlock Text="About" Style="{StaticResource HeaderTextBlockStyle}" />
                            
                            <Border Style="{StaticResource CardBorderStyle}">
                                <StackPanel Spacing="20" HorizontalAlignment="Center">
                                    <Image Source="ms-appx:///Assets/Icons/glyph.png" Width="96" Height="96" />
                                    <StackPanel Spacing="4" HorizontalAlignment="Center">
                                        <TextBlock Text="VibeProxy" FontSize="28" FontWeight="Bold" HorizontalAlignment="Center" />
                                        <TextBlock Text="Version 1.0.0" Foreground="Gray" HorizontalAlignment="Center" />
                                    </StackPanel>

                                    <TextBlock Text="Native Windows companion for VibeProxy with full feature parity to the macOS version. Orchestrate your AI workflows seamlessly."
                                               TextAlignment="Center" TextWrapping="Wrap" MaxWidth="400" />

                                    <StackPanel Spacing="12">
                                        <HyperlinkButton Content="Project Repository" NavigateUri="https://github.com/mweinbach/vibeproxy-win" HorizontalAlignment="Center" />
                                        <HyperlinkButton Content="CLIProxyAPIPlus" NavigateUri="https://github.com/router-for-me/CLIProxyAPIPlus" HorizontalAlignment="Center" />
                                        <HyperlinkButton Content="Report an issue" NavigateUri="https://github.com/mweinbach/vibeproxy-win/issues" HorizontalAlignment="Center" />
                                    </StackPanel>

                                    <Border Height="1" Background="{ThemeResource DividerStrokeColorDefaultBrush}" Margin="0,8" />

                                    <StackPanel Spacing="4">
                                        <TextBlock Text="Â© 2026 Automaze, Ltd." FontSize="13" Foreground="Gray" HorizontalAlignment="Center" />
                                        <TextBlock Text="Licensed under MIT" FontSize="12" Foreground="Gray" HorizontalAlignment="Center" />
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </Grid>
                </ScrollViewer>
            </NavigationView.Content>
        </NavigationView>
    </Grid>
</Page>
